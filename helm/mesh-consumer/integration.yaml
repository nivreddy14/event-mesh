# Camel K Integration YAML (rendered by Helm)
{{- $service := .Values.name }}

{{- $subscriptions := fromYamlArray .Values.subscriptions }}

{{- range $v := $subscriptions  }}
{{- $event := lower $v.event }}
{{- $lob := $v.lob }}
{{- $lobService := $v.service }}
{{- $destinationUri := $v.destination.uri }}

- route:
    from:
      uri: "kamelet:spring-rabbitmq-source"
      parameters:
        host: "camel-k-mesh.camel-k-mesh.svc.cluster.local"
        port: 5672
        # TODO : we shouldn't need exchange name; must be mandatory in the kamelet...
        exchangeName: ex.{{ $lob }}.{{ $lobService }}.{{ $event }}
        queues: q.{{ $service }}.{{ $lob }}.{{ $lobService }}.{{ $event }}
        username: "{{`{{secret:camel-k-mesh-rabbit-user/username}}`}}"
        password: "{{`{{secret:camel-k-mesh-rabbit-user/password}}`}}"
      steps:
      - log: ${body}
      - to:
          uri: {{ $destinationUri }}
{{- end }}
            
