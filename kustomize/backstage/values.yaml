postgresql:
  enabled: true

ingress:
  enabled: true
  host: backstage.127.0.0.1.nip.io
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
  tls:
    enabled: true
    secretName: backstage-tls

# https://artifacthub.io/packages/helm/backstage/backstage
serviceAccount:
  create: true
  name: backstage

backstage:
  image:
    # registry: ghcr.io
    repository: craigedmunds/backstage
    tag: '0.2'
    pullSecrets:
      - ghcr-creds
  extraEnvVars:
    - name: BACKSTAGE_AUTH_LEGACY_GUEST
      value: "true"
    - name: BACKEND_SECRET
      value: dev-backstage-key
  extraEnvVarsSecrets:
    - backstage-github-auth
  extraVolumes:
    - name: backstage-users
      configMap:
        name: backstage-users
    - name: catalog-components
      projected:
        sources:
        - configMap:
            name: catalog-component-camel-k-mesh
        # - configMap:
        #     name: catalog-component-camel-k-mesh-demo
        - configMap:
            name: catalog-component-camel-k-mesh-demo-user-service
        - configMap:
            name: catalog-component-camel-k-mesh-consumer-my-simple-http-service

  extraVolumeMounts:
    - name: backstage-users
      mountPath: /etc/backstage/catalog
      readOnly: true
    - name: catalog-components
      mountPath: /etc/backstage/catalog/components
      readOnly: true
    # - name: catalog-components-demo-user-service
    #   mountPath: /etc/backstage/catalog/components
    #   readOnly: true

  appConfig:
    app:
      title: Backstage
      baseUrl: https://backstage.127.0.0.1.nip.io
    backend:
      baseUrl: https://backstage.127.0.0.1.nip.io
      cors:
        origin: https://backstage.127.0.0.1.nip.io
        credentials: true
        methods: [GET, POST, PUT, DELETE, PATCH]
        allowedHeaders: [Authorization, Content-Type, Cookie]
      auth:
        keys:
          - secret: ${BACKEND_SECRET}
    auth:
      environment: production
      providers:
        github:
          production:
            clientId: ${GITHUB_CLIENT_ID}
            clientSecret: ${GITHUB_CLIENT_SECRET}
            callbackUrl: https://backstage.127.0.0.1.nip.io/api/auth/github/handler/frame
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail
          development:
            clientId: ${GITHUB_CLIENT_ID}
            clientSecret: ${GITHUB_CLIENT_SECRET}
            callbackUrl: https://backstage.127.0.0.1.nip.io/api/auth/github/handler/frame
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail
    catalog:
      locations:
        - type: file
          target: /etc/backstage/catalog/users.yaml
          rules:
            - allow: [User, Group]
        - type: file
          target: /etc/backstage/catalog/components/*.yaml
          rules:
            - allow: [Domain, Component, System, Resource, API, Location, User, Group]
      providers:
        kubernetes:
          local-cluster:
            cluster: in-cluster
            processor:
              namespaceOverride: default
              defaultOwner: apim
            schedule:
              frequency:
                seconds: 30
              timeout:
                seconds: 5
    signIn:
      resolvers:
        - resolver: github
    techdocs:
      builder: local
      generator:
        runIn: docker
      publisher:
        type: local
    kubernetes:
      serviceLocatorMethod:
        type: multiTenant
      clusterLocatorMethods:
        - type: config
          clusters:
            - name: in-cluster
              url: https://kubernetes.default.svc
              authProvider: serviceAccount
              skipTLSVerify: true
      
