apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: camel-k-mesh-consumers
  namespace: argocd
  labels:
    repo: argocd-eda
    branch-strategy: multisource
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
  - git:
      repoURL: https://github.com/craigedmunds/argocd-eda.git
      revision: HEAD
      directories:
      - path: mesh/consumers/*
      values:
        consumer: "{{.path.basename}}"

  template:
    metadata:     
      name: 'camel-k-mesh-consumer-{{.values.consumer}}'
      labels:
        repo: argocd-eda

    spec:
      project: "eventing"
      sources:
        
        - repoURL: https://github.com/craigedmunds/argocd-eda.git
          targetRevision: HEAD
          ref: lob

        - repoURL: https://github.com/craigedmunds/argocd-eda.git
          targetRevision: HEAD
          path: 'helm/mesh-consumer'
          helm:
            # valueFiles:
            # - $lob/mesh/consumers/{{.values.consumer}}/subscriptions.yaml
            
            fileParameters:
            - name: subscriptions
              path: $lob/mesh/consumers/{{.values.consumer}}/subscriptions.yaml

            parameters:
              - name: name
                value: "{{.values.consumer}}"
              
      destination:
        server: https://kubernetes.default.svc
        namespace: "camel-k-mesh-consumer-{{.values.consumer}}"
      syncPolicy:
        syncOptions:
        - CreateNamespace=true