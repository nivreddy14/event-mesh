apiVersion: v1
kind: ConfigMap
metadata:
  name: http-ingress-config
  namespace: camel-k-mesh-http-ingress
  labels:
    app: http-ingress
data:
  integration.yaml: |
    - route:
        id: user-events
        from:
          uri: "platform-http:/api/users/events"
          parameters:
            httpMethodRestrict: POST
          steps:
          - setProperty:
              name: kafkaTopic
              constant: users
          - setProperty:
              name: allowedProducers
              constant: sender-service,user-service
          - setProperty:
              name: allowedEvents
              constant: user.created,user.updated,user.deleted
          - to: "direct:processEvent"

    - route:
        id: order-events
        from:
          uri: "platform-http:/api/orders/events"
          parameters:
            httpMethodRestrict: POST
          steps:
          - setProperty:
              name: kafkaTopic
              constant: orders
          - setProperty:
              name: allowedProducers
              constant: order-service
          - setProperty:
              name: allowedEvents
              constant: order.created,order.updated,order.shipped,order.delivered,order.cancelled
          - to: "direct:processEvent"

    - route:
        id: payment-events
        from:
          uri: "platform-http:/api/payments/events"
          parameters:
            httpMethodRestrict: POST
          steps:
          - setProperty:
              name: kafkaTopic
              constant: payments
          - setProperty:
              name: allowedProducers
              constant: payment-service
          - setProperty:
              name: allowedEvents
              constant: payment.initiated,payment.received,payment.failed,payment.refunded
          - to: "direct:processEvent"
    - route:
        id: inventory-events
        from:
          uri: "platform-http:/api/inventory/events"
          parameters:
            httpMethodRestrict: POST
          steps:
          - setProperty:
              name: kafkaTopic
              constant: inventory
          - setProperty:
              name: allowedProducers
              constant: inventory-service,order-service
          - setProperty:
              name: allowedEvents
              constant: inventory.updated,inventory.reserved,inventory.released
          - to: "direct:processEvent"
    - route:
        id: process-event
        from:
          uri: "direct:processEvent"
          steps:
          - setProperty:
              name: producerId
              simple: "${header.X-Producer-ID}"
          - setProperty:
              name: eventType
              simple: "${header.X-Event-Type}"
          - setProperty:
              name: originalBody
              simple: "${body}"
          
          - log: "Received: endpoint=${exchangeProperty.kafkaTopic} producer=${exchangeProperty.producerId} type=${exchangeProperty.eventType}"          
          - choice:
              when:
                - simple: "${exchangeProperty.producerId} == null || ${exchangeProperty.producerId} == ''"
                  steps:
                  - setHeader:
                      name: CamelHttpResponseCode
                      constant: 400
                  - setBody:
                      simple: '{"error":"Missing X-Producer-ID header"}'
                  - stop: {}
          
          - choice:
              when:
                - simple: "${exchangeProperty.eventType} == null || ${exchangeProperty.eventType} == ''"
                  steps:
                  - setHeader:
                      name: CamelHttpResponseCode
                      constant: 400
                  - setBody:
                      simple: '{"error":"Missing X-Event-Type header"}'
                  - stop: {}
          
          # Check producer authorization
          - choice:
              when:
                - simple: "${exchangeProperty.allowedProducers.contains(${exchangeProperty.producerId})} == false"
                  steps:
                  - setHeader:
                      name: CamelHttpResponseCode
                      constant: 403
                  - setBody:
                      simple: '{"error":"Producer not authorized for this endpoint","producer":"${exchangeProperty.producerId}","allowedProducers":"${exchangeProperty.allowedProducers}"}'
                  - log: "REJECTED: Producer ${exchangeProperty.producerId} not in allowed list ${exchangeProperty.allowedProducers}"
                  - stop: {}
          
          # Check event type authorization
          - choice:
              when:
                - simple: "${exchangeProperty.allowedEvents.contains(${exchangeProperty.eventType})} == false"
                  steps:
                  - setHeader:
                      name: CamelHttpResponseCode
                      constant: 403
                  - setBody:
                      simple: '{"error":"Event type not allowed for this endpoint","eventType":"${exchangeProperty.eventType}","allowedEvents":"${exchangeProperty.allowedEvents}"}'
                  - log: "REJECTED: Event ${exchangeProperty.eventType} not in allowed list ${exchangeProperty.allowedEvents}"
                  - stop: {}
          
          - log: "AUTHORIZED: ${exchangeProperty.producerId} -> ${exchangeProperty.eventType} -> ${exchangeProperty.kafkaTopic}"
          
          # Build CloudEvent
          - setProperty:
              name: eventId
              simple: "${uuid}"
          - setProperty:
              name: eventTime
              simple: "${date:now:yyyy-MM-dd'T'HH:mm:ssXXX}"
          
          - setHeaders:
              headers:
                - name: kafka.KEY
                  simple: "${exchangeProperty.eventId}"
          
          - setBody:
              simple: >
                {
                  "specversion": "1.0",
                  "id": "${exchangeProperty.eventId}",
                  "source": "urn:eda:${exchangeProperty.producerId}",
                  "type": "${exchangeProperty.eventType}",
                  "time": "${exchangeProperty.eventTime}",
                  "data": ${exchangeProperty.originalBody}
                }
          
          # Send to Kafka topic
          - toD:
              uri: "kafka:${exchangeProperty.kafkaTopic}?brokers=my-cluster-kafka-bootstrap.kafka.svc:9092"
          
          - setHeader:
              name: CamelHttpResponseCode
              constant: 202
          - setBody:
              simple: '{"status":"accepted","eventId":"${exchangeProperty.eventId}","topic":"${exchangeProperty.kafkaTopic}","producer":"${exchangeProperty.producerId}","eventType":"${exchangeProperty.eventType}"}'
          - log: "PUBLISHED: ${exchangeProperty.eventId} to ${exchangeProperty.kafkaTopic}"
