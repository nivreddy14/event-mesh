apiVersion: v1
kind: ConfigMap
metadata:
  name: sender-service-config
  namespace: camel-k-mesh-producer-sender-service
  labels:
    app: sender-service
data:
  integration.yaml: |
    - route:
        id: send-user-created
        from:
          uri: "timer:tick?period=30s"
          steps:
          - setProperty:
              name: userId
              simple: "${uuid}"
          - setProperty:
              name: createdAt
              simple: "${date:now:yyyy-MM-dd'T'HH:mm:ssXXX}"
          
          - setBody:
              simple: '{"userId":"${exchangeProperty.userId}","email":"user@example.com","name":"Test User","createdAt":"${exchangeProperty.createdAt}"}'
          
          - setHeaders:
              headers:
                - name: X-Producer-ID
                  constant: sender-service
                - name: X-Event-Type
                  constant: user.created
                - name: Content-Type
                  constant: application/json
          
          - log: "Sending user.created event: ${body}"
          
          - doTry:
              steps:
              - to:
                  uri: "http://http-ingress.camel-k-mesh-http-ingress.svc.cluster.local:8080/api/users/events?httpMethod=POST"
              - log: "Response: ${body}"
              doCatch:
                - exception:
                    - java.lang.Exception
                  steps:
                  - log: "ERROR: ${exception.message}"
